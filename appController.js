/**
 * Created by Kostya on 12/3/2018.
 */

var derp = [
    {
        "price": 35,
        "imageUrl": "images/img01.jpg",
        "$$hashKey": "object:4",
        "id": 1
    },
    {
        "price": 60,
        "imageUrl": "images/img02.jpg",
        "$$hashKey": "object:5",
        "id": 2
    },
    {
        "price": 30,
        "imageUrl": "images/img03.jpg",
        "$$hashKey": "object:6",
        "id": 3
    },
    {
        "price": 70,
        "imageUrl": "images/img04.jpg",
        "$$hashKey": "object:7",
        "id": 4
    },
    {
        "price": 70,
        "imageUrl": "images/img05.jpg",
        "$$hashKey": "object:8",
        "id": 5
    },
    {
        "price": 160,
        "imageUrl": "images/img06.jpg",
        "$$hashKey": "object:9",
        "id": 6
    },
    {
        "price": 150,
        "imageUrl": "images/img07.jpg",
        "$$hashKey": "object:10",
        "id": 7
    },
    {
        "price": 80,
        "imageUrl": "images/img08.jpg",
        "$$hashKey": "object:11",
        "id": 8
    },
    {
        "price": 30,
        "imageUrl": "images/img09.jpg",
        "$$hashKey": "object:12",
        "id": 9
    },
    {
        "price": 70,
        "imageUrl": "images/img10.jpg",
        "$$hashKey": "object:13",
        "id": 10
    },
    {
        "price": 50,
        "imageUrl": "images/img11.jpg",
        "$$hashKey": "object:14",
        "id": 11
    },
    {
        "price": 110,
        "imageUrl": "images/img12.jpg",
        "$$hashKey": "object:15",
        "id": 12
    },
    {
        "price": 120,
        "imageUrl": "images/img13.jpg",
        "$$hashKey": "object:16",
        "id": 13
    },
    {
        "price": 180,
        "imageUrl": "images/img14.jpg",
        "$$hashKey": "object:17",
        "id": 14
    },
    {
        "price": 160,
        "imageUrl": "images/img15.jpg",
        "$$hashKey": "object:18",
        "id": 15
    },
    {
        "price": 110,
        "imageUrl": "images/img16.jpg",
        "$$hashKey": "object:19",
        "id": 16
    },
    {
        "price": 60,
        "imageUrl": "images/img17.jpg",
        "$$hashKey": "object:20",
        "id": 17
    },
    {
        "price": 60,
        "imageUrl": "images/img18.jpg",
        "$$hashKey": "object:21",
        "id": 18
    },
    {
        "price": 70,
        "imageUrl": "images/img19.jpg",
        "$$hashKey": "object:22",
        "id": 19
    },
    {
        "price": 180,
        "imageUrl": "images/img20.jpg",
        "$$hashKey": "object:23",
        "id": 20
    },
    {
        "price": 100,
        "imageUrl": "images/img21.jpg",
        "$$hashKey": "object:24",
        "id": 21
    },
    {
        "price": 80,
        "imageUrl": "images/img22.jpg",
        "$$hashKey": "object:25",
        "id": 22
    },
    {
        "price": 50,
        "imageUrl": "images/img23.jpg",
        "$$hashKey": "object:26",
        "id": 23
    },
    {
        "price": 80,
        "imageUrl": "images/img24.jpg",
        "$$hashKey": "object:27",
        "id": 24
    },
    {
        "price": 250,
        "imageUrl": "images/img25.jpg",
        "$$hashKey": "object:28",
        "id": 25
    },
    {
        "price": 60,
        "imageUrl": "images/img26.jpg",
        "$$hashKey": "object:29",
        "id": 26
    },
    {
        "price": 50,
        "imageUrl": "images/img27.jpg",
        "$$hashKey": "object:30",
        "id": 27
    },
    {
        "price": 130,
        "imageUrl": "images/img28.jpg",
        "$$hashKey": "object:31",
        "id": 28
    },
    {
        "price": 130,
        "imageUrl": "images/img29.jpg",
        "$$hashKey": "object:32",
        "id": 29
    },
    {
        "price": 70,
        "imageUrl": "images/img30.jpg",
        "$$hashKey": "object:33",
        "id": 30
    },
    {
        "price": 70,
        "imageUrl": "images/img31.jpg",
        "$$hashKey": "object:34",
        "id": 31
    },
    {
        "price": 90,
        "imageUrl": "images/img32.jpg",
        "$$hashKey": "object:35",
        "id": 32
    },
    {
        "price": 110,
        "imageUrl": "images/img33.jpg",
        "$$hashKey": "object:36",
        "id": 33
    },
    {
        "price": 80,
        "imageUrl": "images/img34.jpg",
        "$$hashKey": "object:37",
        "id": 34
    },
    {
        "price": 20,
        "imageUrl": "images/img35.jpg",
        "$$hashKey": "object:38",
        "id": 35
    },
    {
        "price": 45,
        "imageUrl": "images/img36.jpg",
        "$$hashKey": "object:39",
        "id": 36
    },
    {
        "price": 100,
        "imageUrl": "images/img37.jpg",
        "$$hashKey": "object:40",
        "id": 37
    },
    {
        "price": 100,
        "imageUrl": "images/img38.jpg",
        "$$hashKey": "object:41",
        "id": 38
    },
    {
        "price": 200,
        "imageUrl": "images/img39.jpg",
        "$$hashKey": "object:42",
        "id": 39
    },
    {
        "price": 250,
        "imageUrl": "images/img40.jpg",
        "$$hashKey": "object:43",
        "id": 40
    },
    {
        "price": 40,
        "imageUrl": "images/img41.jpg",
        "$$hashKey": "object:44",
        "id": 41
    },
    {
        "price": 50,
        "imageUrl": "images/img42.jpg",
        "$$hashKey": "object:45",
        "id": 42
    },
    {
        "price": 80,
        "imageUrl": "images/img43.jpg",
        "$$hashKey": "object:46",
        "id": 43
    },
    {
        "price": 180,
        "imageUrl": "images/img44.jpg",
        "$$hashKey": "object:47",
        "id": 44
    },
    {
        "price": 145,
        "imageUrl": "images/img45.jpg",
        "$$hashKey": "object:48",
        "id": 45
    },
    {
        "price": 30,
        "imageUrl": "images/img46.jpg",
        "$$hashKey": "object:49",
        "id": 46
    },
    {
        "price": 90,
        "imageUrl": "images/img47.jpg",
        "$$hashKey": "object:50",
        "id": 47
    },
    {
        "price": 30,
        "imageUrl": "images/img48.jpg",
        "$$hashKey": "object:51",
        "id": 48
    },
    {
        "price": 80,
        "imageUrl": "images/img49.jpg",
        "$$hashKey": "object:52",
        "id": 49
    },
    {
        "price": 60,
        "imageUrl": "images/img50.jpg",
        "$$hashKey": "object:53",
        "id": 50
    },
    {
        "price": 140,
        "imageUrl": "images/img51.jpg",
        "$$hashKey": "object:54",
        "id": 51
    },
    {
        "price": 60,
        "imageUrl": "images/img52.jpg",
        "$$hashKey": "object:55",
        "id": 52
    },
    {
        "price": 70,
        "imageUrl": "images/img53.jpg",
        "$$hashKey": "object:56",
        "id": 53
    },
    {
        "price": 65,
        "imageUrl": "images/img54.jpg",
        "$$hashKey": "object:57",
        "id": 54
    },
    {
        "price": 80,
        "imageUrl": "images/img55.jpg",
        "$$hashKey": "object:58",
        "id": 55
    },
    {
        "price": 60,
        "imageUrl": "images/img56.jpg",
        "$$hashKey": "object:59",
        "id": 56
    },
    {
        "price": 30,
        "imageUrl": "images/img57.jpg",
        "$$hashKey": "object:60",
        "id": 57
    },
    {
        "price": 80,
        "imageUrl": "images/img58.jpg",
        "$$hashKey": "object:61",
        "id": 58
    },
    {
        "price": 140,
        "imageUrl": "images/img59.jpg",
        "$$hashKey": "object:62",
        "id": 59
    },
    {
        "price": 80,
        "imageUrl": "images/img60.jpg",
        "$$hashKey": "object:63",
        "id": 60
    },
    {
        "price": 100,
        "imageUrl": "images/img61.jpg",
        "$$hashKey": "object:64",
        "id": 61
    },
    {
        "price": 50,
        "imageUrl": "images/img62.jpg",
        "$$hashKey": "object:65",
        "id": 62
    },
    {
        "price": 160,
        "imageUrl": "images/img63.jpg",
        "$$hashKey": "object:66",
        "id": 63
    },
    {
        "price": 100,
        "imageUrl": "images/img64.jpg",
        "$$hashKey": "object:67",
        "id": 64
    },
    {
        "price": 10,
        "imageUrl": "images/img65.jpg",
        "$$hashKey": "object:68",
        "id": 65
    },
    {
        "price": 20,
        "imageUrl": "images/img66.jpg",
        "$$hashKey": "object:69",
        "id": 66
    },
    {
        "price": 200,
        "imageUrl": "images/img67.jpg",
        "$$hashKey": "object:70",
        "id": 67
    },
    {
        "price": 80,
        "imageUrl": "images/img68.jpg",
        "$$hashKey": "object:71",
        "id": 68
    },
    {
        "price": 50,
        "imageUrl": "images/img69.jpg",
        "$$hashKey": "object:72",
        "id": 69
    },
    {
        "price": 20,
        "imageUrl": "images/img70.jpg",
        "$$hashKey": "object:73",
        "id": 70
    },
    {
        "price": 80,
        "imageUrl": "images/img71.jpg",
        "$$hashKey": "object:74",
        "id": 71
    }
];

function removeProduct(products) {
    var what, a = arguments, L = a.length, ax;
    while (L > 1 && products.length) {
        what = a[--L];
        while ((ax = products.indexOf(what)) !== -1) {
            products.splice(ax, 1);
        }
    }
    return products;
}

var app = angular.module('myApp', ['ngMaterial', 'ngMessages']);
app.controller('myCtrl', function ($scope) {
    $scope.loginScreen = true;
    $scope.products = derp;
    $scope.cart = [];
    $scope.total = 0;
    $scope.startTime = new Date();

    $scope.loginStudent = function (id) {
        if (id && id.match(/^[0-9]{3}$/)) {
            $scope.loginScreen = false;
            $scope.productScreen = true;
            $scope.studentId = id;
        }
    }

    $scope.addToCart = function (item) {
        if ($scope.total + item.price <= 500) {
            $scope.total += item.price;
            item.in_cart = true;
            $scope.cart.push(item.id);
        }
    };

    $scope.removeFromCart = function (item) {
        $scope.total -= item.price;
        item.in_cart = false;
        $scope.cart = removeProduct($scope.cart, item.id);
    };

    $scope.checkout = function () {
        var time = (new Date() - $scope.startTime) / 1000;

        var url = '/save';
        var data = {studentId: $scope.studentId, spent: $scope.total, timeSpentInShop: time, cart: $scope.cart };

        fetch(url, {
            method: 'POST', // or 'PUT'
            body: JSON.stringify(data),
            headers: new Headers({
                'Content-Type': 'application/json'
            })
        }).then(function (res) {
            return res.json();
        })
            .catch(function (error) {
                console.error('Error:', error);
            })
            .then(function (response) {
                $scope.productScreen = false;
                $scope.endScreen = true;
                $scope.$apply()
                console.log('Success:', response);
            });
    };
});